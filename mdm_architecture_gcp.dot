digraph GCP_MDM_Architecture {
  rankdir=TB;
  node [shape=box, style=rounded];
  compound=true;

  subgraph cluster_legend {
    label = "Legend";
    style=filled;
    fillcolor="#F5F5F5";
    GCP_Service [label="GCP Service", fillcolor="#E1F5FE", style="filled,solid"];
    Data_Storage [label="Data / Storage", shape=cylinder, fillcolor="#FFF8E1", style="filled,solid"];
    Process_Step [label="Process / Step", shape=ellipse, fillcolor="#E0F7FA", style="filled,solid"];
  }

  // Survivorship rules node
  Survivorship_Rules [label="Survivorship Rules\n(Defined by Business)", shape=cylinder, fillcolor="#FFF8E1", style="filled,solid"];

  subgraph cluster_ingestion {
    label = "1. Data Ingestion & Collection";
    bgcolor="#F0F4C3";
    Sources [label="Source Systems\n(CRM, ERP, Files)", shape=cylinder, fillcolor="#FFF8E1"];
    GCS_Landing [label="GCS Landing Zone", shape=cylinder, fillcolor="#FFF8E1"];
    PubSub [label="Pub/Sub", fillcolor="#E1F5FE"];
    Dataflow [label="Dataflow / \nCloud Data Fusion", fillcolor="#E1F5FE"];
    BQ_DataTransfer [label="BQ Data Transfer\nService", fillcolor="#E1F5FE"];

    Sources -> GCS_Landing [label="Batch/Files"];
    Sources -> PubSub [label="Real-time"];
    Sources -> BQ_DataTransfer [label="SaaS/Scheduled"];
    PubSub -> Dataflow [label="Streaming"];
    GCS_Landing -> Dataflow [label="Batch"];
    BQ_DataTransfer -> BQ_Staging [label="Direct Load"];
  }

  subgraph cluster_processing {
    label = "2. Data Preparation & Mastering (GCP Native)";
    bgcolor="#F3E5F5";
    BQ_Staging [label="BQ Staging / \nCleansing Zone", fillcolor="#E1F5FE"];
    Dataplex_DQ [label="Dataplex\n(Data Quality)", fillcolor="#E1F5FE"];
    CloudFunctions [label="Cloud Functions\n(Enrichment, e.g., Geocoding)", fillcolor="#E1F5FE"];

    // Stewardship Nodes
    AppSheet_UI [label="AppSheet\n(Stewardship UI)", fillcolor="#E1F5FE"];
    BQ_Stewardship_Queue [label="BQ Stewardship\nQueue", shape=cylinder, fillcolor="#FFF8E1"];
    Write_Mastered_Data [label="Write Mastered Data", shape=ellipse, fillcolor="#E0F7FA"];

    subgraph cluster_matching {
      label = "Matching & Entity Resolution";
      BQ_SQL_Match [label="BQ SQL Match\n(Rules, Fuzzy)", fillcolor="#E1F5FE"];
      VertexAI_Embed [label="Vertex AI Embeddings", fillcolor="#E1F5FE"];
      BQ_VectorSearch [label="BQ VECTOR_SEARCH", fillcolor="#E1F5FE"];
      BQ_EntityRes [label="BQ Entity Resolution\n(e.g., LiveRamp)", fillcolor="#E1F5FE"];
      Match_Results [label="Match Groups", shape=ellipse, fillcolor="#E0F7FA"];
    }

    BQ_Golden [label="BQ Master Data\n(Golden Records)", shape=cylinder, fillcolor="#FFF8E1"];

    // Data flow
    Dataflow -> BQ_Staging [label="Load Staging"];
    BQ_Staging -> Dataplex_DQ [label="Quality Checks"];
    Dataplex_DQ -> BQ_Staging;
    BQ_Staging -> CloudFunctions [label="Enrich"];
    CloudFunctions -> BQ_Staging;

    BQ_Staging -> BQ_SQL_Match;
    BQ_Staging -> VertexAI_Embed -> BQ_VectorSearch;
    BQ_Staging -> BQ_VectorSearch;
    BQ_Staging -> BQ_EntityRes;

    BQ_SQL_Match -> Match_Results;
    BQ_VectorSearch -> Match_Results;
    BQ_EntityRes -> Match_Results;

    // Human-in-the-loop process
    Match_Results -> Write_Mastered_Data [label="High-confidence\nmatches"];
    Match_Results -> BQ_Stewardship_Queue [label="Low-confidence\nmatches"];
    BQ_Stewardship_Queue -> AppSheet_UI [dir=both, style=dashed, label="Review & Fix"];
    AppSheet_UI -> Write_Mastered_Data [label="Human-verified\nmatches"];
    Write_Mastered_Data -> BQ_Golden;
  }

  subgraph cluster_governance {
    label = "3. Data Governance";
    bgcolor="#B2EBF2";
    Dataplex_Catalog [label="Dataplex\n(Catalog, Lineage, Glossary)", fillcolor="#E1F5FE"];
    IAM [label="Cloud IAM\n(Access Control)", fillcolor="#E1F5FE"];
    BQ_Security [label="BigQuery Security\n(Row/Col Level)", fillcolor="#E1F5FE"];
    Cloud_DLP [label="Cloud DLP\n(PII Detection & Masking)", fillcolor="#E1F5FE"];

    BQ_Golden -> Dataplex_Catalog;
    BQ_Golden -> Cloud_DLP [style=dashed, label="Scan & Classify"];
    Dataplex_Catalog -> IAM [style=dashed];
    Dataplex_Catalog -> BQ_Security [style=dashed];
  }

  subgraph cluster_distribution {
    label = "4. Distribution & Consumption";
    bgcolor="#FFCCBC";
    Consuming_Systems [label="Consuming Systems\n(Apps, Analytics)", shape=cylinder, fillcolor="#E8F5E9"];
    Looker [label="Looker", fillcolor="#E1F5FE"];
    Apigee [label="Apigee (APIs)", fillcolor="#E1F5FE"];
    PubSub_Changes [label="Pub/Sub (Change Events)", fillcolor="#E1F5FE"];
    CloudSQL_Spanner [label="Cloud SQL/Spanner\n(Operational Store)", shape=cylinder, fillcolor="#FFF8E1"];

    BQ_Golden -> Looker;
    BQ_Golden -> Apigee -> Consuming_Systems;
    BQ_Golden -> PubSub_Changes -> Consuming_Systems;
    BQ_Golden -> CloudSQL_Spanner [label="Syndicate"];
    CloudSQL_Spanner -> Consuming_Systems [label="Low-latency\nLookups"];

    // Connect survivorship rules
    Survivorship_Rules -> Write_Mastered_Data [label="Apply Rules"];
  }

  // Metadata connections
  BQ_Staging -> Dataplex_Catalog [style=dotted, label="Metadata Ingest"];

  // Layout hints
  {rank=same; Looker; Apigee; PubSub_Changes}
}
