digraph ThirdParty_MDM_Architecture {
  rankdir=TB;
  node [shape=box, style=rounded];
  compound=true;

  subgraph cluster_legend {
    label = "Legend";
    style=filled;
    fillcolor="#F5F5F5";
    GCP_Service [label="GCP Service", fillcolor="#E1F5FE", style="filled,solid"];
    Third_Party [label="Third-Party Tool\n(e.g., Tamr)", fillcolor="#E6F4EA", style="filled,solid"];
    Data_Storage [label="Data / Storage", shape=cylinder, fillcolor="#FFF8E1", style="filled,solid"];
    Process_Step [label="Process / Step", shape=ellipse, fillcolor="#E0F7FA", style="filled,solid"];
  }

  subgraph cluster_ingestion {
    label = "1. Data Ingestion & Collection";
    bgcolor="#F0F4C3";
    Sources [label="Source Systems\n(CRM, ERP, Files)", shape=cylinder, fillcolor="#FFF8E1"];
    GCS_Landing [label="GCS Landing Zone", shape=cylinder, fillcolor="#FFF8E1"];
    PubSub [label="Pub/Sub", fillcolor="#E1F5FE"];
    Dataflow [label="Dataflow / \nCloud Data Fusion", fillcolor="#E1F5FE"];
    BQ_DataTransfer [label="BQ Data Transfer\nService", fillcolor="#E1F5FE"];

    Sources -> GCS_Landing [label="Batch/Files"];
    Sources -> PubSub [label="Real-time"];
    Sources -> BQ_DataTransfer [label="SaaS/Scheduled"];
    PubSub -> Dataflow [label="Streaming"];
    GCS_Landing -> Dataflow [label="Batch"];
    BQ_DataTransfer -> BQ_Input [label="Direct Load"];
  }

  subgraph cluster_processing {
    label = "2. Data Preparation & Mastering (Third-Party)";
    bgcolor="#C8E6C9";
    BQ_Input [label="BQ Input Data\n(Staging)", fillcolor="#E1F5FE"];
    Tamr [label="Tamr on GCP\n(ML-based Mastering)\n\nAlternatives:\n• Reltio\n• Informatica IDMC", fillcolor="#E6F4EA", height=2.0];
    BQ_Golden [label="BQ Master Data\n(Golden Records)", shape=cylinder, fillcolor="#FFF8E1"];

    // Data flow
    Dataflow -> BQ_Input [label="Load Input Data"];
    BQ_Input -> Tamr [label="Read for Processing"];
    Tamr -> BQ_Golden [label="Write Mastered Data"];
    Tamr -> GCS_Landing [style=dashed, label="Config/Logs"];
  }

  subgraph cluster_governance {
    label = "3. Data Governance";
    bgcolor="#B2EBF2";
    Dataplex_Catalog [label="Dataplex\n(Catalog, Lineage, Glossary)", fillcolor="#E1F5FE"];
    IAM [label="Cloud IAM\n(Access Control)", fillcolor="#E1F5FE"];
    BQ_Security [label="BigQuery Security\n(Row/Col Level)", fillcolor="#E1F5FE"];
    Cloud_DLP [label="Cloud DLP\n(PII Detection & Masking)", fillcolor="#E1F5FE"];

    BQ_Golden -> Dataplex_Catalog;
    BQ_Golden -> Cloud_DLP [style=dashed, label="Scan & Classify"];
    Dataplex_Catalog -> IAM [style=dashed];
    Dataplex_Catalog -> BQ_Security [style=dashed];
  }

  subgraph cluster_distribution {
    label = "4. Distribution & Consumption";
    bgcolor="#FFCCBC";
    Consuming_Systems [label="Consuming Systems\n(Apps, Analytics)", shape=cylinder, fillcolor="#E8F5E9"];
    Looker [label="Looker", fillcolor="#E1F5FE"];
    Apigee [label="Apigee (APIs)", fillcolor="#E1F5FE"];
    PubSub_Changes [label="Pub/Sub (Change Events)", fillcolor="#E1F5FE"];
    CloudSQL_Spanner [label="Cloud SQL/Spanner\n(Operational Store)", shape=cylinder, fillcolor="#FFF8E1"];

    BQ_Golden -> Looker;
    BQ_Golden -> Apigee -> Consuming_Systems;
    BQ_Golden -> PubSub_Changes -> Consuming_Systems;
    BQ_Golden -> CloudSQL_Spanner [label="Syndicate"];
    CloudSQL_Spanner -> Consuming_Systems [label="Low-latency\nLookups"];
  }

  // Metadata connections
  BQ_Input -> Dataplex_Catalog [style=dotted, label="Metadata Ingest"];

  // Layout hints
  {rank=same; Looker; Apigee; PubSub_Changes}
}
